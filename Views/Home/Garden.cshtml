@{
    Layout = null;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {
        background: linear-gradient(135deg, #d9f9d9, #bde0fe);
        min-height: 100vh;
    }

    .card {
        border-radius: 20px;
        border: none;
        box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    }

    th, td {
        vertical-align: middle;
        text-align: center;
    }

    th.sortable {
        cursor: pointer;
        user-select: none;
    }
    th.sortable:after {
        content: " ⬍";
        font-size: 0.8em;
        opacity: 0.4;
    }
    th.sortable.asc:after { content: " ↑"; }
    th.sortable.desc:after { content: " ↓"; }

    .overdue { background-color: #ffe0e0 !important; }

    .btn { border-radius: 10px; transition: all 0.2s ease; }
    .btn-primary:hover, .btn-outline-primary:hover { transform: scale(1.05); }
    .btn-outline-danger:hover { transform: scale(1.05); }

    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
</style>

<div class="container py-5">
    <div class="card p-4">
        <h1 class="text-center mb-4 text-success">My Garden</h1>
        <div class="mb-3 text-start">
            <a href="/Home/Index" class="btn btn-secondary">← Back</a>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
                <thead class="table-success">
                    <tr>
                        <th class="sortable" data-column="name" style="width: 15%;">Plant Name</th>
                        <th class="sortable" data-column="date" style="width: 15%;">Planted Date</th>
                        <th class="sortable" data-column="comment" style="width: 20%;">Comment</th>
                        <th class="sortable" data-column="waterEvery" style="width: 13%;">Water Every (days)</th>
                        <th class="sortable" data-column="next" style="width: 15%;">Next Watering</th>
                        <th style="width: 6%;">Water</th>
                        <th style="width: 6%;">Edit</th>
                        <th style="width: 6%;">Delete</th>
                    </tr>
                </thead>
                <tbody id="plantTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Plant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIndex">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Plant Name</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDate" class="form-label">Planted Date</label>
                        <input type="date" class="form-control" id="editDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editComment" class="form-label">Comment</label>
                        <textarea class="form-control" id="editComment" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editWaterEvery" class="form-label">Water Every (days)</label>
                        <input type="number" class="form-control" id="editWaterEvery" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const tableBody = document.getElementById("plantTableBody");
const headerCells = document.querySelectorAll("thead th.sortable");
const editModal = new bootstrap.Modal(document.getElementById("editModal"));
const form = document.getElementById("editForm");

const editIndexInput = document.getElementById("editIndex");
const editName = document.getElementById("editName");
const editDate = document.getElementById("editDate");
const editComment = document.getElementById("editComment");
const editWaterEvery = document.getElementById("editWaterEvery");

let plants = JSON.parse(localStorage.getItem("plants") || "[]");
let sortColumn = "date";
let sortDirection = -1;

function formatDate(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
}

function getNextWatering(plant) {
    const baseDate = plant.lastWatered || plant.date;
    if (baseDate && plant.waterEvery) {
        return new Date(new Date(baseDate).getTime() + plant.waterEvery*86400000);
    }
    return null;
}

function shouldWaterToday(nextDate) {
    if (!nextDate) return false;
    const today = new Date(); today.setHours(0,0,0,0);
    const compareDate = new Date(nextDate); compareDate.setHours(0,0,0,0);
    return compareDate <= today;
}

function renderTable() {
    tableBody.innerHTML = "";
    plants.forEach(p => { if(!p.lastWatered) p.lastWatered=p.date; });

    plants.forEach((plant,index)=>{
        const nextWateringDate = getNextWatering(plant);
        const row = document.createElement("tr");

        if(shouldWaterToday(nextWateringDate)) row.classList.add("overdue");

        row.innerHTML = `
            <td>${plant.name||"-"}</td>
            <td>${formatDate(plant.date)}</td>
            <td>${plant.comment||"-"}</td>
            <td>${plant.waterEvery||"-"}</td>
            <td>${nextWateringDate?formatDate(nextWateringDate):"-"}</td>
            <td><button class="btn btn-primary btn-sm" onclick="waterPlant(${index})" ${!shouldWaterToday(nextWateringDate)?"disabled":""}><i class="bi bi-droplet"></i></button></td>
            <td><button class="btn btn-outline-primary btn-sm" onclick="editPlant(${index})"><i class="bi bi-pencil"></i></button></td>
            <td><button class="btn btn-outline-danger btn-sm" onclick="confirmDelete(${index})"><i class="bi bi-x-lg"></i></button></td>
        `;
        tableBody.appendChild(row);
    });

    localStorage.setItem("plants", JSON.stringify(plants));
}

function waterPlant(index) {
    plants[index].lastWatered = new Date().toISOString();
    renderTable();
}

function confirmDelete(index) {
    if(confirm("Are you sure you want to delete this plant?")) {
        plants.splice(index,1);
        renderTable();
    }
}

function editPlant(index){
    const plant = plants[index];
    editIndexInput.value = index;
    editName.value = plant.name;
    editDate.value = plant.date;
    editComment.value = plant.comment||"";
    editWaterEvery.value = plant.waterEvery||1;
    editModal.show();
}

form.addEventListener("submit", e=>{
    e.preventDefault();
    const index=parseInt(editIndexInput.value);
    const name=editName.value.trim();
    const date=editDate.value;
    const comment=editComment.value.trim();
    const waterEvery=parseInt(editWaterEvery.value);

    if(!name||!date||isNaN(waterEvery)||waterEvery<1){ alert("Fill all fields correctly."); return; }

    plants[index]={ ...plants[index], name, date, comment, waterEvery, lastWatered: date };
    renderTable();
    editModal.hide();
});

function sortTable(column){
    if(sortColumn===column) sortDirection*=-1;
    else { sortColumn=column; sortDirection=1; }

    headerCells.forEach(th=>th.classList.remove("asc","desc"));
    const activeHeader = document.querySelector(`th[data-column="${column}"]`);
    if(activeHeader) activeHeader.classList.add(sortDirection===1?"asc":"desc");

    plants.sort((a,b)=>{
        let valA = column==="date"?new Date(a.date||0):
                   column==="next"?getNextWatering(a)||0:
                   column==="waterEvery"?parseInt(a.waterEvery||0):
                   (a[column]||"").toString().toLowerCase();
        let valB = column==="date"?new Date(b.date||0):
                   column==="next"?getNextWatering(b)||0:
                   column==="waterEvery"?parseInt(b.waterEvery||0):
                   (b[column]||"").toString().toLowerCase();
        return valA<valB?-1*sortDirection:valA>valB?1*sortDirection:0;
    });

    renderTable();
}

headerCells.forEach(th=>th.addEventListener("click",()=>sortTable(th.dataset.column)));
sortTable("date");
</script>
